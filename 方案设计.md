
---

# 🧭 AI九宫格3D出图系统设计方案报告

> **版本：v1.0**
> **撰写时间：2025-10-13**
> **作者：大铭DAMING**

---

## 一、项目概述

### 🎯 项目目标

构建一个可在 **电脑端与移动端自适应访问** 的在线工具，用户上传 10 张图片后：

1. 选择 1 张作为主图；
2. 其余 9 张自动拼成带白色间隙的九宫格；
3. 系统将九宫格叠加到空白背景（3:4 比例）底部；
4. 调用后端 **抠图 API** 抠出主图人物/物体；
5. 将主图叠加在画面右上方，实现“3D出格”效果；
6. 用户可在线预览与下载结果。

---

## 二、功能需求分析

| 模块    | 功能描述                    | 备注                    |
| ----- | ----------------------- | --------------------- |
| 图片上传  | 用户一次上传 10 张图片           | 支持拖拽上传                |
| 主图选择  | 从上传图片中点击选择 1 张          | 高亮显示选中状态              |
| 九宫格生成 | 9 张图按顺序自动排布成九宫格，带白色间隙   | 间隙可配置（默认 10px）        |
| 背景合成  | 九宫格叠加到空白背景上，底部对齐，上部留空一行 | 背景比例 3:4              |
| 主图抠图  | 调用后端API实现背景去除           | 后端使用开源抠图模型            |
| 主图叠加  | 将抠图结果叠加到右上角，可调整偏移       | 默认右上角偏移 10%           |
| 导出功能  | 生成并下载最终合成图              | 支持 JPG/PNG            |
| 响应式设计 | 适配 PC 与移动端              | 使用 CSS Grid + Flex 实现 |

---

## 三、系统架构设计

```
┌────────────────────────────────────────────┐
│                 前端（Next.js + Tailwind）             │
│ - 图片上传与主图选择 UI                           │
│ - 预览九宫格与合成结果                             │
│ - 响应式布局（PC/移动端自适应）                    │
│ - 调用后端 API（上传、抠图、生成）                 │
└───────────────────┬──────────────────────────┘
                    │  RESTful API
                    ▼
┌────────────────────────────────────────────┐
│               后端（Flask + Python）               │
│  /upload        → 接收图片上传                     │
│  /remove_bg     → 调用开源抠图模型API              │
│  /compose       → 九宫格生成 + 背景叠加 + 主图合成 │
│  /download/<id> → 提供最终结果下载链接              │
└───────────────────┬──────────────────────────┘
                    │
                    ▼
┌────────────────────────────────────────────┐
│             模型与存储服务层                    │
│ - 抠图API：rembg / U²-Net / Segment Anything    │
│ - 图片缓存：/tmp 或 AWS S3（临时）               │
│ - 部署：Render（Flask），Vercel（Next.js）       │
└────────────────────────────────────────────┘
```

---

## 四、处理流程说明

### Step 1️⃣ 图片上传

* 用户上传 10 张图片（多文件上传）
* 前端调用 `/upload` 接口
* 后端保存图片临时路径并返回唯一 task_id

---

### Step 2️⃣ 主图选择

* 前端点击任意一张设为主图（index 标记）
* 将 `main_index` 提交给后端 `/compose` 接口

---

### Step 3️⃣ 九宫格生成

* 使用前 9 张图生成九宫格（3x3）
* 每张图缩放为固定尺寸（如 300×300）
* 图片间距（如 10px）为白色边带

```python
def make_grid(images, cell_size=300, gap=10):
    total = cell_size*3 + gap*2
    grid = Image.new("RGB", (total, total), (255,255,255))
    for i, img in enumerate(images[:9]):
        img = img.resize((cell_size, cell_size))
        x = (i % 3) * (cell_size + gap)
        y = (i // 3) * (cell_size + gap)
        grid.paste(img, (x, y))
    return grid
```

---

### Step 4️⃣ 背景叠加

* 生成一张 3:4 比例的空白背景
  例如：`900 × 1200` 像素
* 将九宫格粘贴到底部，使顶部留白 1 行空格

```python
def add_background(grid, bg_color=(255,255,255)):
    w, h = grid.size
    bg_h = int(h * 4 / 3)
    bg = Image.new("RGB", (w, bg_h), bg_color)
    offset_y = bg_h - h
    bg.paste(grid, (0, offset_y))
    return bg
```

---

### Step 5️⃣ 主图抠图

* 调用 `/remove_bg` 接口
* 后端封装开源模型 `rembg` 或 `segment-anything`
* 输出透明背景 PNG 图片

```python
from rembg import remove

@app.route("/remove_bg", methods=["POST"])
def remove_bg():
    file = request.files["image"]
    input = file.read()
    result = remove(input)
    return send_file(io.BytesIO(result), mimetype="image/png")
```

---

### Step 6️⃣ 主图叠加

* 将抠出的主图叠加到右上角
* 可通过前端控制偏移量与缩放比例

```python
def overlay_subject(bg, subject, scale=0.9, offset=(50, 50)):
    w, h = bg.size
    sw, sh = subject.size
    subject = subject.resize((int(sw*scale), int(sh*scale)))
    bg.paste(subject, offset, subject)
    return bg
```

---

### Step 7️⃣ 输出结果

* 生成最终合成图，保存至临时目录 `/tmp/{task_id}.jpg`
* 通过 `/download/<task_id>` 提供下载

---

## 五、API 接口设计

| 接口                    | 方法   | 参数                                          | 返回值              | 说明        |
| --------------------- | ---- | ------------------------------------------- | ---------------- | --------- |
| `/upload`             | POST | files[] (10张图)                              | `{task_id}`      | 上传图片并创建任务 |
| `/remove_bg`          | POST | `image`                                     | PNG              | 单独抠图功能    |
| `/compose`            | POST | `{task_id, main_index, offset_x, offset_y}` | `{download_url}` | 生成最终合成图   |
| `/download/<task_id>` | GET  | -                                           | JPG 文件           | 下载结果图像    |

---

## 六、前端设计（Next.js）

### 📄 页面结构

```
/pages/index.jsx
/components/
  ├── ImageUploader.jsx
  ├── GridPreview.jsx
  ├── MainSelector.jsx
  ├── ControlPanel.jsx
  └── ResultPreview.jsx
```

### 💡 样式说明

* 使用 **Tailwind CSS**
* PC 端九宫格：Grid 布局
* 移动端：单列展示上传与预览区
* 响应式断点：`md:` `lg:` 控制两栏布局

---

### 🧩 前端逻辑流程

1. 选择 10 张图片上传（`POST /upload`）
2. 选择主图（本地状态标记）
3. 调整参数（出格位置、缩放）
4. 点击“生成”，发送 `/compose` 请求
5. 预览生成结果
6. 点击“下载图片”

---

## 七、技术选型说明

| 模块 | 技术栈                    | 说明            |
| -- | ---------------------- | ------------- |
| 前端 | Next.js + Tailwind     | 响应式 UI，良好 SEO |
| 后端 | Flask + Pillow + rembg | 轻量化、易部署       |
| 模型 | U²-Net (rembg 内核)      | 效果稳定、无需GPU    |
| 存储 | 本地 `/tmp` 或 AWS S3     | 临时缓存          |
| 部署 | Vercel（前端）+ Render（后端） | 免费方案可行        |

---

## 八、系统性能与兼容性

| 项目     | 指标                            |
| ------ | ----------------------------- |
| 处理时长   | 每张图约 1~2 秒                    |
| 输出图像大小 | 默认 1080×1440                  |
| 支持设备   | Windows / Mac / Android / iOS |
| 浏览器    | Chrome, Safari, Edge, Firefox |

---

## 九、安全与清理策略

* 临时文件 2 小时后自动清理（cron 定时任务）
* 上传文件限制大小 ≤ 10MB
* 防止重复提交（task_id 校验）
* 禁止执行任意文件写入

---

## 十、部署方案建议

| 环节   | 工具                          | 说明              |
| ---- | --------------------------- | --------------- |
| 前端   | Vercel                      | 一键托管 Next.js 项目 |
| 后端   | Render / Hugging Face Space | 支持 Flask Web 服务 |
| 文件存储 | 临时放置 `/tmp` 或使用 S3 Bucket   | 后台自动清理          |
| 抠图模型 | rembg（Python包）              | 无需额外依赖          |

---

## 十一、可扩展功能规划

| 功能           | 描述                  | 实现方式              |
| ------------ | ------------------- | ----------------- |
| 🌈 多模板选择     | 支持不同九宫格样式（边框/阴影）    | 模板 PNG 叠加         |
| 🧠 AI自动选主图   | 使用 OpenCV 人脸检测选最突出图 | CV 算法识别           |
| 🎨 自定义出格方向   | 支持左上、右下等多方向         | 前端参数控制            |
| 💾 一键保存社交图尺寸 | 输出正方形 or 长图版本       | Pillow 裁切         |
| 💰 SaaS化     | 限制次数 + 登录 + 会员解锁    | Firebase + Stripe |

---

## 十二、开发阶段计划

| 阶段  | 周期            | 目标                 |
| --- | ------------- | ------------------ |
| 第1周 | 环境搭建 + 本地脚本验证 | 实现九宫格 + 抠图 + 合成    |
| 第2周 | Flask API 实现  | 封装接口并测试            |
| 第3周 | 前端上传与预览       | 完成上传与UI交互          |
| 第4周 | 前后端联调与部署      | Vercel + Render 联通 |
| 第5周 | 增加响应式与体验优化    | 手机端适配              |
| 第6周 | 上线测试与推广       | 开放访问链接             |

---

## 十三、成果示意图（逻辑示例）

```
┌──────────────┐
│   九宫格背景   │  ← 底部覆盖
│ ┌────┬────┬────┐
│ │ 图1 │ 图2 │ 图3 │
│ ├────┼────┼────┤
│ │ 图4 │ 图5 │ 图6 │
│ ├────┼────┼────┤
│ │ 图7 │ 图8 │ 图9 │
│ └────┴────┴────┘
│   ↑ 留出上方1行空白
│
│ 主图叠加于右上角
│ → 带透明背景，出格效果
└──────────────┘
```

---

## 十四、总结

本项目具有：

* 🧩 技术可行性强（使用成熟图像处理与抠图方案）
* 📱 用户体验良好（支持自适应与在线预览）
* 💰 市场可推广性（朋友圈九宫格类玩法具传播性）

实现后可作为：

* 【个人工具站项目】展示技术实力；
* 【AI视觉类SaaS雏形】进一步拓展付费模板；
* 【AI编程实战案例】在课程/公众号输出内容。

---
